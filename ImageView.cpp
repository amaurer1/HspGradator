//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// ImageView.cpp
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// Copyright (c) 2020 Adrian Maurer. All rights reserved.
// Distributed under the GPL-3.0 software license (https://opensource.org/licenses/GPL-3.0).
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#include "pch.h"
#include "framework.h"
#include "HspGradatorApp.h"
#include "ImageView.h"
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#ifdef _DEBUG
#define new DEBUG_NEW
#endif
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CImageView
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CImageView - CONSTRUCTION / DESTRUCTION / ASSIGNMENT
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CImageView::CImageView() : 
	p_image(nullptr), 
	wndSize(0, 0), 
	imageOrigin(0, 0), 
	imageSize(0, 0)
{
}
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
IMPLEMENT_DYNCREATE(CImageView, CView)
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CImageView - ELEMENT FUNCTIONS
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void CImageView::update(const CTrueColorImage* const p_mi)
{
	p_image = p_mi;
}
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void CImageView::recalcLayout()
{
	if (p_image && !p_image->IsNull())
	{
		const float isr = static_cast<float>(p_image->calcSizeRatio());
		const CSize& ws = wndSize;
		const float wsr = ws.cy / static_cast<float>(ws.cx);
		const float f = 1.025F;
		if (isr < 1.0F)
		{
			if (isr < wsr)
			{
				imageSize.cx = roundTo<int>(ws.cx / f);
				imageSize.cy = roundTo<int>(ws.cx / f * isr);
			}
			else
			{
				imageSize.cx = roundTo<int>(ws.cy / f / isr);
				imageSize.cy = roundTo<int>(ws.cy / f);
			}
		}
		else
		{
			if (isr > wsr)
			{
				imageSize.cx = roundTo<int>(ws.cy / f / isr);
				imageSize.cy = roundTo<int>(ws.cy / f);
			}
			else
			{
				imageSize.cx = roundTo<int>(ws.cx / f);
				imageSize.cy = roundTo<int>(ws.cx / f * isr);
			}
		}
		imageOrigin.x = roundTo<int>((ws.cx - imageSize.cx) / 2.0F);
		imageOrigin.y = roundTo<int>((ws.cy - imageSize.cy) / 2.0F);
	}
}
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void CImageView::refresh()
{
	Invalidate(FALSE);
	UpdateWindow();
}
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CImageView - OVERRIDES
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
BOOL CImageView::PreCreateWindow(CREATESTRUCT& cs)
{
	if (!CView::PreCreateWindow(cs)) return FALSE;
	cs.dwExStyle |= WS_EX_CLIENTEDGE;
	cs.style &= ~WS_BORDER;
	cs.lpszClass = AfxRegisterWndClass(CS_HREDRAW | CS_VREDRAW | CS_DBLCLKS, ::LoadCursor(nullptr, IDC_ARROW));
	return TRUE;
}
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void CImageView::OnDraw(CDC* p_dc)
{
	const COLORREF bc = ::GetSysColor(COLOR_3DLIGHT);
	if (p_dc)
	{
		if (p_image && !p_image->IsNull())
		{
			p_dc->FillSolidRect(0, 0, imageOrigin.x, wndSize.cy, bc);
			p_dc->FillSolidRect(imageOrigin.x + imageSize.cx, 0, wndSize.cx - imageOrigin.x - imageSize.cx, wndSize.cy, bc);
			p_dc->FillSolidRect(imageOrigin.x, 0, imageSize.cx, imageOrigin.y, bc);
			p_dc->FillSolidRect(imageOrigin.x, imageOrigin.y + imageSize.cy, imageSize.cx, wndSize.cy - imageOrigin.y - imageSize.cy, bc);
			p_dc->SetStretchBltMode(COLORONCOLOR);
			p_image->StretchBlt(p_dc->GetSafeHdc(), imageOrigin.x, imageOrigin.y, imageSize.cx, imageSize.cy);
		}
		else
		{
			CRect wr(0, 0, wndSize.cx, wndSize.cy);
			p_dc->FillSolidRect(wr, bc);
			p_dc->SetTextColor(::GetSysColor(COLOR_WINDOWTEXT));
			p_dc->DrawText(L"Double click to load image", &wr, DT_SINGLELINE | DT_CENTER | DT_VCENTER);
		}
	}
}
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CImageView - MESSAGE MAP FUNCTIONS
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
BEGIN_MESSAGE_MAP(CImageView, CView)
	ON_WM_SIZE()
	ON_WM_LBUTTONDBLCLK()
END_MESSAGE_MAP()
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void CImageView::OnSize(UINT type, int cx, int cy)
{
	CView::OnSize(type, cx, cy);
	wndSize = {cx, cy};
	recalcLayout();
	refresh();
}
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void CImageView::OnLButtonDblClk(UINT flags, CPoint point)
{
	sendMessageToMainWnd(WM_COMMAND, ID_FILE_LOAD_IMAGE);
	CView::OnLButtonDblClk(flags, point);
}
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
